FROM {{ namespace }}/{{ image_prefix }}base:{{ tag }}
LABEL maintainer="{{ maintainer }}" name="{{ image_name }}" build-date="{{ build_date }}"

{% block rabbitmq_header %}{% endblock %}

{% import "macros.j2" as macros with context %}

{{ macros.configure_user(name='rabbitmq') }}

{% block rabbitmq_install %}
{% if base_package_type == 'rpm' %}
# NOTE(mandre) Remove rabbitmq-server pinning once package dependencies are met
# https://bugs.launchpad.net/kolla/+bug/1814233
    {% set rabbitmq_packages = [
        'hostname',
    ] %}

{% elif base_package_type == 'deb' %}
    {% set rabbitmq_packages = [
        'erlang-nox',
        'logrotate'
    ] %}

    {% if base_distro == 'debian' %}
         {% set rabbitmq_packages = rabbitmq_packages + [
             'rabbitmq-server',
         ] %}
    {% else %}
         {% set rabbitmq_packages = rabbitmq_packages + [
             'rabbitmq-server=3.7.10-1',
         ] %}
    {% endif %}

    {% if base_arch == 'aarch64' %}
         {% set rabbitmq_packages = rabbitmq_packages + [
             'erlang-base',
         ] %}
    {% else %}
         {% set rabbitmq_packages = rabbitmq_packages + [
             'erlang-base-hipe',
         ] %}

    {% endif %}

{% endif %}

RUN yum install -y wget && \
  wget http://10.10.101.3/images/sw_64/rabbitmq-server-3.3.5-34.ns7.noarch.rpm http://10.10.101.3/images/sw_64/erlang-xmerl-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-wx-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-webtool-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-typer-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-tv-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-tools-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-toolbar-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-test_server-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-syntax_tools-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-stdlib-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-ssl-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-ssh-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-snmp-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-sasl-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-runtime_tools-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-reltool-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-public_key-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-pman-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-percept-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-parsetools-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-otp_mibs-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-os_mon-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-orber-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-odbc-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-observer-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-mnesia-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-megaco-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-kernel-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-jinterface-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-inets-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-ic-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-hipe-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-gs-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-examples-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-eunit-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-et-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-erts-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-erl_interface-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-erl_docgen-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-eldap-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-edoc-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-diameter-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-dialyzer-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-debuginfo-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-debugger-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-crypto-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-cosTransactions-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-cosTime-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-cosProperty-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-cosNotification-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-cosFileTransfer-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-cosEventDomain-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-cosEvent-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-compiler-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-common_test-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-asn1-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-appmon-R16B-03.18.ns7.sw_64.rpm http://10.10.101.3/images/sw_64/erlang-R16B-03.18.ns7.sw_64.rpm && \
  yum install -y *.rpm && \
  rm ./*.rpm && \
  yum remove -y wget


{{ macros.install_packages(rabbitmq_packages | customizable("packages")) }}

{% endblock %}

COPY extend_start.sh /usr/local/bin/kolla_extend_start
COPY rabbitmq_get_gospel_node.py /usr/local/bin/rabbitmq_get_gospel_node
RUN chmod 755 /usr/local/bin/kolla_extend_start /usr/local/bin/rabbitmq_get_gospel_node

{% block rabbitmq_footer %}{% endblock %}
{% block footer %}{% endblock %}

USER rabbitmq
